<!DOCTYPE html><html lang=en-gb> <meta charset=utf-8> <title>Testing Django data migrations | Tom Carrick</title> <meta name=viewport content="width=device-width, initial-scale=1"> <link href=https://carrick.eu/theme/images/logo.svg rel=icon type=image/svg+xml> <link href=https://carrick.eu/theme/css/main.min.css?21779674 rel=stylesheet> <meta name=author content="Tom Carrick"> <meta name=generator content=Pelican> <link href=https://carrick.eu/feeds/all.atom.xml type=application/atom+xml rel=alternate title="Tom Carrick Full Atom Feed"> <meta property=og:site_name content="Tom Carrick"> <meta property=og:locale content=en_GB> <meta property=og:image content=https://carrick.eu/theme/images/logo.png> <meta property=og:image:alt content="Tom Carrick"> <meta property=og:image:width content=300> <meta property=og:image:height content=300> <meta name=twitter:image content=https://carrick.eu/theme/images/logo.png> <meta name=twitter:image:alt content="Tom Carrick"> <meta property=og:type content=website> <meta name=twitter:card content=summary> <meta name=twitter:creator content=@knyghty> <meta name=twitter:site content=@knyghty> <link href=https://carrick.eu/theme/css/pygments-default.min.css?6a4fb53a rel=stylesheet> <link href=https://carrick.eu/blog/testing-django-data-migrations/ rel=canonical> <meta content=https://carrick.eu/blog/testing-django-data-migrations/ property=og:url> <meta name=tags content=django> <meta name=tags content=testing> <meta name=tags content=migrations> <header class=site-header> <nav> <a href=https://carrick.eu/ class=home-link> <svg viewbox="0 0 90 90" xmlns=http://www.w3.org/2000/svg fill=#9b59d0 class=logo role=presentation> <g class=t> <rect width=74 height=16></rect> <rect x=31 height=90 width=16></rect> </g> <g class=c> <rect x=31 height=16 width=55></rect> <rect x=31 height=90 width=16></rect> <rect x=31 y=74 height=16 width=55></rect> </g> </svg> Home </a> <a href=https://carrick.eu/blog/ >Blog</a> <a href=https://carrick.eu/cv/ >CV</a> <a href=https://carrick.eu/about/ >About</a> </nav> </header> <main> <section class=content-area> <header class=content-header> <h1>Testing Django data migrations</h1> Published: <time datetime=2022-01-12T00:00:00+01:00>12 January 2022</time> </header> <div class=content> <p>You probably already know the value of testing your code. Your Django migrations are code, therefore you should test them. However, testing data migrations in particular can be tricky, and there's no documentation on how to do it.</p> <p>Typically your schema migrations don't need any testing as your migrations are run during tests, unless you're <a class="reference external" href=https://docs.djangoproject.com/en/4.0/ref/settings/#migrate>skipping migrations</a> to speed up your tests. I recommend against doing this, but that's another blog post.</p> <p>However, only your data migrations <em>forwards</em> are tested. Even then, they are only tested if they don't have any branching, and if there is something to do. Most data migrations during tests have nothing to do because there is no data during migrations to run against. But why test data migrations in the first place?</p> <div class=section id=why-test-your-data-migrations> <h2>Why test your data migrations?</h2> <p>I often use data migrations for a few purposes. The first is to add initial data. For example, you might want to store a list of countries in the database. You don't want to add them directly to the database, but you want them to always be there, and if some new country is formed in the future, you can add it in another data migration, say. This could also be done with a management command or in a multitude of other ways, so it's not the main reason for using a data migration.</p> <p>The other reason is probably more useful. You'll often have a new requirement that needs you to restructure your database, and as a part of that, you have to make a change to some of your data. For example, you might decide to add a required username to your user model, and to populate the initial values, you want to use the first part of the user's email address. Please don't do this in real life. Generating public information from private information is not very good for a user's privacy.</p> <p>Testing these with real data is important. You may have users in your database with valid emails where the username part wouldn't validate as a username. As migrations are typically only ran once in production, you'll certainly find out when you deploy and run your migrations that something is wrong. However, is the data in your staging environment as good as that in your production environment? Even if it is, it would be nice to find these problems earlier, and without the stress of dealing with potential problems that aborting a deployment can entail.</p> </div> <div class=section id=how-to-test-your-data-migrations> <h2>How to test your data migrations?</h2> <p>If you find yourself doing this a lot, there is a package called <a class="reference external" href=https://github.com/wemake-services/django-test-migrations>django-test-migrations</a>. I haven't used it myself but it will probably be more robust than the simple approach below. However, if you're averse to installing yet another package, let's see what we can put together without too much work.</p> <p>Let's use the example above and say we have the following data migration:</p> <div class=highlight><pre><span></span><span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>migrations</span>

<span class=k>def</span> <span class=nf>populate_usernames</span><span class=p>(</span><span class=n>apps</span><span class=p>,</span> <span class=n>schema_editor</span><span class=p>):</span>
    <span class=n>User</span> <span class=o>=</span> <span class=n>apps</span><span class=o>.</span><span class=n>get_model</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;User&quot;</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>user</span> <span class=ow>in</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>all</span><span class=p>():</span>
        <span class=n>user</span><span class=o>.</span><span class=n>username</span> <span class=o>=</span> <span class=n>user</span><span class=o>.</span><span class=n>email</span><span class=o>.</span><span class=n>rpartition</span><span class=p>(</span><span class=s2>&quot;@&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
        <span class=n>user</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>

<span class=k>def</span> <span class=nf>depopulate_usernames</span><span class=p>(</span><span class=n>apps</span><span class=p>,</span> <span class=n>schema_editor</span><span class=p>):</span>
    <span class=n>User</span> <span class=o>=</span> <span class=n>apps</span><span class=o>.</span><span class=n>get_model</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;User&quot;</span><span class=p>)</span>
    <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>

<span class=k>class</span> <span class=nc>Migration</span><span class=p>(</span><span class=n>migrations</span><span class=o>.</span><span class=n>Migration</span><span class=p>):</span>
    <span class=n>dependencies</span> <span class=o>=</span> <span class=p>[(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;0002_add_username&quot;</span><span class=p>)]</span>
    <span class=n>operations</span> <span class=o>=</span> <span class=p>[</span><span class=n>migrations</span><span class=o>.</span><span class=n>RunPython</span><span class=p>(</span><span class=n>populate_usernames</span><span class=p>,</span> <span class=n>depopulate_usernames</span><span class=p>)]</span>
</pre></div> <p>To test migrations like this, I decided to write a small class to run the migrations. You may notice that this is a class with a single method and <tt class="docutils literal">__init__</tt>, so it could just be a function, but setting the <tt class="docutils literal">apps</tt> attribute felt better than returning <tt class="docutils literal">apps</tt> directly.</p> <div class=highlight><pre><span></span><span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>connection</span>
<span class=kn>from</span> <span class=nn>django.db.migrations.executor</span> <span class=kn>import</span> <span class=n>MigrationExecutor</span>


<span class=k>class</span> <span class=nc>Migrator</span><span class=p>:</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>connection</span><span class=o>=</span><span class=n>connection</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>executor</span> <span class=o>=</span> <span class=n>MigrationExecutor</span><span class=p>(</span><span class=n>connection</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>migrate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>app_label</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>migration</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
        <span class=n>target</span> <span class=o>=</span> <span class=p>[(</span><span class=n>app_label</span><span class=p>,</span> <span class=n>migration</span><span class=p>)]</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>executor</span><span class=o>.</span><span class=n>loader</span><span class=o>.</span><span class=n>build_graph</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>executor</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>target</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>apps</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>executor</span><span class=o>.</span><span class=n>loader</span><span class=o>.</span><span class=n>project_state</span><span class=p>(</span><span class=n>target</span><span class=p>)</span><span class=o>.</span><span class=n>apps</span>
</pre></div> <p>There's not too much going on here. We initialise the class with a migration executor, using a passed connection, or the default connection if none is passed. Then you can run the <tt class="docutils literal">migrate</tt> method, with your app label and migration name. This will run the migration and set the <tt class="docutils literal">apps</tt> attribute that you'll use in your test to make sure you have the right version of the models, similar to how it's used in the data migration itself.</p> <p>Using the migrator in pytest is pretty simple. We can write a single-line fixture:</p> <div class=highlight><pre><span></span><span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span>
<span class=k>def</span> <span class=nf>migrator</span><span class=p>():</span>
    <span class=k>return</span> <span class=n>Migrator</span>
</pre></div> <p>Then we can write our tests, migrating to where we need to be:</p> <div class=highlight><pre><span></span><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>django_db</span>
<span class=k>def</span> <span class=nf>test_populate_emails</span><span class=p>(</span><span class=n>migrator</span><span class=p>):</span>
    <span class=n>migrator</span> <span class=o>=</span> <span class=n>migrator</span><span class=p>()</span>
    <span class=n>migrator</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;0002_add_username&quot;</span><span class=p>)</span>
    <span class=n>User</span> <span class=o>=</span> <span class=n>migrator</span><span class=o>.</span><span class=n>apps</span><span class=o>.</span><span class=n>get_model</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;User&quot;</span><span class=p>)</span>
    <span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create_user</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=s2>&quot;test123@example.com&quot;</span><span class=p>)</span>
    <span class=k>assert</span> <span class=n>user</span><span class=o>.</span><span class=n>username</span> <span class=ow>is</span> <span class=kc>None</span>

    <span class=n>migrator</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;0003_populate_usernames&quot;</span><span class=p>)</span>
    <span class=k>assert</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=s2>&quot;test123@example.com&quot;</span><span class=p>,</span> <span class=n>username</span><span class=o>=</span><span class=s2>&quot;test123&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>()</span>
</pre></div> <p>Of course, we can also migrate backwards. Typically, migrating backwards is only used when developing, but in case you want that 100% coverage or really want to be sure:</p> <div class=highlight><pre><span></span><span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>django_db</span>
<span class=k>def</span> <span class=nf>test_depopulate_emails</span><span class=p>(</span><span class=n>migrator</span><span class=p>):</span>
    <span class=n>migrator</span> <span class=o>=</span> <span class=n>migrator</span><span class=p>()</span>
    <span class=n>migrator</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;0002_add_username&quot;</span><span class=p>)</span>
    <span class=n>User</span> <span class=o>=</span> <span class=n>migrator</span><span class=o>.</span><span class=n>apps</span><span class=o>.</span><span class=n>get_model</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;User&quot;</span><span class=p>)</span>
    <span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create_user</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=s2>&quot;test123@example.com&quot;</span><span class=p>)</span>
    <span class=n>migrator</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;0003_populate_usernames&quot;</span><span class=p>)</span>
    <span class=n>migrator</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;0002_add_username&quot;</span><span class=p>)</span>
    <span class=n>User</span> <span class=o>=</span> <span class=n>migrator</span><span class=o>.</span><span class=n>apps</span><span class=o>.</span><span class=n>get_model</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;user&quot;</span><span class=p>)</span>
    <span class=k>assert</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=s2>&quot;test123@example.com&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>username</span> <span class=ow>is</span> <span class=kc>None</span>
</pre></div> <div class=section id=unittest> <h3>unittest</h3> <p>If you're using Django's default unittest framework, you can use it in much the same way:</p> <div class=highlight><pre><span></span><span class=kn>from</span> <span class=nn>django.test</span> <span class=kn>import</span> <span class=n>TestCase</span>


<span class=k>class</span> <span class=nc>MigrationTest</span><span class=p>(</span><span class=n>TestCase</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>migrator</span> <span class=o>=</span> <span class=n>Migrator</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>migrator</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;0002_add_username&quot;</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>test_populate_usernames</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>User</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>migrator</span><span class=o>.</span><span class=n>apps</span><span class=o>.</span><span class=n>get_model</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;User&quot;</span><span class=p>)</span>
        <span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create_user</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=s2>&quot;test123@example.com&quot;</span><span class=p>)</span>
        <span class=k>assert</span> <span class=n>user</span><span class=o>.</span><span class=n>username</span> <span class=ow>is</span> <span class=kc>None</span>

        <span class=n>migrator</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;0003_populate_usernames&quot;</span><span class=p>)</span>
        <span class=k>assert</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
            <span class=n>email</span><span class=o>=</span><span class=s2>&quot;test123@example.com&quot;</span><span class=p>,</span> <span class=n>username</span><span class=o>=</span><span class=s2>&quot;test123&quot;</span>
        <span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>()</span>

    <span class=k>def</span> <span class=nf>test_depopulate_emails</span><span class=p>(</span><span class=n>migrator</span><span class=p>):</span>
        <span class=n>User</span> <span class=o>=</span> <span class=n>migrator</span><span class=o>.</span><span class=n>apps</span><span class=o>.</span><span class=n>get_model</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;User&quot;</span><span class=p>)</span>
        <span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create_user</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=s2>&quot;test123@example.com&quot;</span><span class=p>)</span>
        <span class=n>migrator</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;0003_populate_usernames&quot;</span><span class=p>)</span>
        <span class=n>migrator</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;0002_add_username&quot;</span><span class=p>)</span>
        <span class=n>User</span> <span class=o>=</span> <span class=n>migrator</span><span class=o>.</span><span class=n>apps</span><span class=o>.</span><span class=n>get_model</span><span class=p>(</span><span class=s2>&quot;accounts&quot;</span><span class=p>,</span> <span class=s2>&quot;user&quot;</span><span class=p>)</span>
        <span class=k>assert</span> <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=s2>&quot;test123@example.com&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>username</span> <span class=ow>is</span> <span class=kc>None</span>
</pre></div> <p>So, get out there and test those data migrations.</p> </div> </div> </div> <footer class=content-footer> <div class=tags> Tags: <a href=https://carrick.eu/blog/tags/django/ >django</a> <a href=https://carrick.eu/blog/tags/testing/ >testing</a> <a href=https://carrick.eu/blog/tags/migrations/ >migrations</a> </div> </footer> </section> </main> <footer class=site-footer> © Tom Carrick <ul class="inline unstyled"> <li><a href=https://github.com/knyghty>GitHub</a></li> <li><a href=https://twitter.com/knyghty>Twitter</a></li> </ul> </footer> <script src=https://carrick.eu/theme/js/print.js></script> </html>